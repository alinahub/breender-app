{"ast":null,"code":"import _regeneratorRuntime from\"/Users/alinaturbina/Uni Projects/seba/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _asyncToGenerator from\"/Users/alinaturbina/Uni Projects/seba/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _defineProperty from\"/Users/alinaturbina/Uni Projects/seba/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _toConsumableArray from\"/Users/alinaturbina/Uni Projects/seba/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/toConsumableArray\";import _slicedToArray from\"/Users/alinaturbina/Uni Projects/seba/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useEffect,useState,useRef}from'react';import{connect,useSelector,dispatch}from'react-redux';import{useDispatch}from'react-redux';import{getMessages,addMessage,updateMessagesToSeen,getUnseenMessages}from'redux/actions/messageActions';import{Grid,Paper,Divider,Typography,List,ListItem,ListItemText,Button,Icon,Fab}from'@material-ui/core';import{makeStyles}from'@material-ui/core/styles';import SendIcon from'@material-ui/icons/Send';import TextField from'@material-ui/core/TextField';import ConversationComponent from'./ConversationComponent';import MessageComponent from'./MessageComponent';import Loading from'components/Loading';import io from'socket.io-client';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";function MessengerComponent(props){var _jsx2;var classes=useStyles();var dispatch=useDispatch();var _useState=useState([]),_useState2=_slicedToArray(_useState,2),conversations=_useState2[0],setConversations=_useState2[1];var _useState3=useState(null),_useState4=_slicedToArray(_useState3,2),currentChat=_useState4[0],setCurrentChat=_useState4[1];var _useState5=useState([]),_useState6=_slicedToArray(_useState5,2),messages=_useState6[0],setMessages=_useState6[1];var _useState7=useState(null),_useState8=_slicedToArray(_useState7,2),arrivalMessage=_useState8[0],setArrivalMessage=_useState8[1];var socket=useRef();var userId=useSelector(function(state){return state.user.user.id;});var loadedConversations=useSelector(function(state){return state.conversations.conversations;});var unseenMessages=useSelector(function(state){return state.messages.unseenMessages;});useEffect(function(){socket.current=io('ws://localhost:8900');socket.current.on('getMessage',function(data){setArrivalMessage({sender:data.senderId,text:data.text,createdAt:Date.now()});});},[]);useEffect(function(){arrivalMessage&&(currentChat===null||currentChat===void 0?void 0:currentChat.members.includes(arrivalMessage.sender))&&setMessages(function(prev){return[].concat(_toConsumableArray(prev),[arrivalMessage]);});},[arrivalMessage,currentChat]);useEffect(function(){socket.current.emit('addUser',userId);},[userId]);useEffect(function(){if(props.currentConversationId){setCurrentChat(loadedConversations.find(function(c){return c.id=props.currentConversationId;}));}},[props.currentConversationId]);useEffect(function(){if(currentChat&&userId){dispatch(getUnseenMessages(userId));}},[currentChat]);return/*#__PURE__*/_jsx(\"div\",{className:classes.layout,children:/*#__PURE__*/_jsxs(Grid,{container:true,component:Paper,className:classes.chatSection,children:[/*#__PURE__*/_jsx(ChatMenuComponent,{conversations:props.conversations,currentUser:props.currentUser}),/*#__PURE__*/_jsx(Grid,{item:true,xs:9,children:currentChat?/*#__PURE__*/_jsx(ChatBoxComponent,{conversation:currentChat}):/*#__PURE__*/_jsx(Typography,(_jsx2={variant:\"h2\",className:\"header-message\"},_defineProperty(_jsx2,\"className\",classes.instructions),_defineProperty(_jsx2,\"children\",\"Open a conversation to start a chat...\"),_jsx2))})]})});function ChatMenuComponent(menuProps){var classes=useStyles();var _useState9=useState(''),_useState10=_slicedToArray(_useState9,2),searchName=_useState10[0],setSearchName=_useState10[1];var handleSearchChange=function handleSearchChange(e){setSearchName(e.target.value);};return/*#__PURE__*/_jsxs(Grid,{item:true,xs:3,className:classes.chatMenu,children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:12,className:classes.padding10,children:/*#__PURE__*/_jsx(TextField,{className:classes.searchField,InputLabelProps:{classeName:classes.label},color:\"secondary\",variant:\"outlined\",label:\"Filter breeders...\",onChange:handleSearchChange,fullWidth:true})}),/*#__PURE__*/_jsx(Divider,{}),/*#__PURE__*/_jsx(List,{children:menuProps.conversations.filter(function(c){if(c){if(c.members){var friend=c.members.find(function(m){return m._id!==props.currentUser.id;});if(friend.username){return friend.username.toLowerCase().includes(searchName.toLowerCase());}}}}).map(function(c){return/*#__PURE__*/_jsx(\"div\",{onClick:function onClick(){setCurrentChat(c);},children:/*#__PURE__*/_jsx(ConversationComponent,{conversation:c,currentUser:menuProps.currentUser,isCurrentChat:currentChat?c._id==currentChat._id:false})});})})]});}// TODO: Make scrolling to bottom message automatic\nfunction ChatBoxComponent(chatProps){var _jsxs2;var classes=useStyles();var _useState11=useState(''),_useState12=_slicedToArray(_useState11,2),newMessage=_useState12[0],setNewMessage=_useState12[1];useEffect(function(){var conversationId=chatProps.conversation._id;function loadMessages(_x){return _loadMessages.apply(this,arguments);}function _loadMessages(){_loadMessages=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(id){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(!id){_context.next=3;break;}_context.next=3;return dispatch(getMessages(id));case 3:case\"end\":return _context.stop();}}},_callee);}));return _loadMessages.apply(this,arguments);}return loadMessages(conversationId);},[dispatch]);var loadedMessages=useSelector(function(state){return state.messages.messages;});useEffect(function(){setMessages(loadedMessages);},[loadedMessages]);useEffect(function(){if(Array.isArray(loadedMessages)&&loadedMessages.length!==0){var _unseenMessages=loadedMessages.filter(function(m){return!m.seen&&m.sender!==userId;}).map(function(m){return m._id;});if(_unseenMessages.length!==0){dispatch(updateMessagesToSeen(_unseenMessages));}}},[loadedMessages]);var handleSubmit=/*#__PURE__*/function(){var _ref=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee2(e){var receiver,message;return _regeneratorRuntime.wrap(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:// Prevents refreshing of page on click\nif(e){e.preventDefault();}receiver=currentChat.members.find(function(member){return member._id!==userId;});message={sender:userId,receiver:receiver._id,text:newMessage,seen:false,conversationId:chatProps.conversation._id};setMessages(_toConsumableArray(messages));socket.current.emit('sendMessage',{senderId:userId,receiverId:receiver._id,receiverEmail:receiver.email,receiverUsername:receiver.username,text:newMessage});dispatch(addMessage(message));setNewMessage('');case 7:case\"end\":return _context2.stop();}}},_callee2);}));return function handleSubmit(_x2){return _ref.apply(this,arguments);};}();return!currentChat?/*#__PURE__*/_jsx(Loading,{}):/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(List,{className:classes.messageArea,children:Array.isArray(messages)&&messages.length!==0?messages.map(function(m){return/*#__PURE__*/_jsx(MessageComponent,{message:m});}):/*#__PURE__*/_jsxs(Typography,(_jsxs2={variant:\"h2\",className:\"header-message\"},_defineProperty(_jsxs2,\"className\",classes.instructions),_defineProperty(_jsxs2,\"children\",[\"Send a message to start a conversation with\",' ',currentChat.members.find(function(m){return m._id!==props.currentUser.id;}).username,\"...\"]),_jsxs2))}),/*#__PURE__*/_jsx(Divider,{}),/*#__PURE__*/_jsxs(Grid,{container:true,className:classes.padding20,children:[/*#__PURE__*/_jsx(Grid,{item:true,xs:11,children:/*#__PURE__*/_jsx(TextField,{id:\"outlined-basic\",variant:\"outlined\",label:\"Write something...\",onChange:function onChange(e){return setNewMessage(e.target.value);},fullWidth:true})}),/*#__PURE__*/_jsx(Grid,{item:true,xs:1,children:/*#__PURE__*/_jsx(Fab,{color:\"primary\",\"aria-label\":\"add\",onClick:handleSubmit,className:classes.marginLeft10,children:/*#__PURE__*/_jsx(SendIcon,{})})})]})]});}}var useStyles=makeStyles(function(theme){return{layout:{width:'80%',alignSelf:'center',paddingTop:theme.spacing(1)},table:{minWidth:650},chatSection:{width:'100%',height:'85vh'},headBG:{backgroundColor:'#e0e0e0'},chatMenu:{borderRight:'1px solid #e0e0e0',backgroundColor:theme.palette.primary.dark,borderRadius:theme.shape.borderRadius},messageArea:{height:'70vh',overflowY:'auto'},padding10:{padding:'10px'},padding20:{padding:'20px'},marginLeft10:{marginLeft:'10px'},instructions:{padding:'20px',color:theme.palette.primary.light},searchField:{color:theme.palette.text.secondary,'& fieldset':{borderColor:theme.palette.primary.light},'& .MuiOutlinedInput-root':{'&:hover fieldset':{borderColor:theme.palette.secondary.main}},'&.Mui-focused fieldset':{borderColor:theme.palette.secondary.main},'& label':{color:theme.palette.primary.light}}};});export default MessengerComponent;","map":{"version":3,"sources":["/Users/alinaturbina/Uni Projects/seba/frontend/src/components/messenger/MessengerComponent.js"],"names":["React","useEffect","useState","useRef","connect","useSelector","dispatch","useDispatch","getMessages","addMessage","updateMessagesToSeen","getUnseenMessages","Grid","Paper","Divider","Typography","List","ListItem","ListItemText","Button","Icon","Fab","makeStyles","SendIcon","TextField","ConversationComponent","MessageComponent","Loading","io","MessengerComponent","props","classes","useStyles","conversations","setConversations","currentChat","setCurrentChat","messages","setMessages","arrivalMessage","setArrivalMessage","socket","userId","state","user","id","loadedConversations","unseenMessages","current","on","data","sender","senderId","text","createdAt","Date","now","members","includes","prev","emit","currentConversationId","find","c","layout","chatSection","currentUser","instructions","ChatMenuComponent","menuProps","searchName","setSearchName","handleSearchChange","e","target","value","chatMenu","padding10","searchField","classeName","label","filter","friend","m","_id","username","toLowerCase","map","ChatBoxComponent","chatProps","newMessage","setNewMessage","conversationId","conversation","loadMessages","loadedMessages","Array","isArray","length","seen","handleSubmit","preventDefault","receiver","member","message","receiverId","receiverEmail","email","receiverUsername","messageArea","padding20","marginLeft10","theme","width","alignSelf","paddingTop","spacing","table","minWidth","height","headBG","backgroundColor","borderRight","palette","primary","dark","borderRadius","shape","overflowY","padding","marginLeft","color","light","secondary","borderColor","main"],"mappings":"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","sourcesContent":["import React, { useEffect, useState, useRef } from 'react';\nimport { connect, useSelector, dispatch } from 'react-redux';\nimport { useDispatch } from 'react-redux';\nimport { getMessages, addMessage, updateMessagesToSeen, getUnseenMessages } from 'redux/actions/messageActions';\nimport { Grid, Paper, Divider, Typography, List, ListItem, ListItemText, Button, Icon, Fab } from '@material-ui/core';\nimport { makeStyles } from '@material-ui/core/styles';\nimport SendIcon from '@material-ui/icons/Send';\nimport TextField from '@material-ui/core/TextField';\nimport ConversationComponent from './ConversationComponent';\nimport MessageComponent from './MessageComponent';\nimport Loading from 'components/Loading';\nimport io from 'socket.io-client';\n\nfunction MessengerComponent(props) {\n    const classes = useStyles();\n    const dispatch = useDispatch();\n    const [conversations, setConversations] = useState([]);\n    const [currentChat, setCurrentChat] = useState(null);\n    const [messages, setMessages] = useState([]);\n    const [arrivalMessage, setArrivalMessage] = useState(null);\n    const socket = useRef();\n    const userId = useSelector((state) => state.user.user.id);\n    const loadedConversations = useSelector((state) => state.conversations.conversations);\n    const unseenMessages = useSelector((state) => state.messages.unseenMessages);\n\n    useEffect(() => {\n        socket.current = io('ws://localhost:8900');\n        socket.current.on('getMessage', (data) => {\n            setArrivalMessage({\n                sender: data.senderId,\n                text: data.text,\n                createdAt: Date.now(),\n            });\n        });\n    }, []);\n\n    useEffect(() => {\n        arrivalMessage && currentChat?.members.includes(arrivalMessage.sender) && setMessages((prev) => [...prev, arrivalMessage]);\n    }, [arrivalMessage, currentChat]);\n\n    useEffect(() => {\n        socket.current.emit('addUser', userId);\n    }, [userId]);\n\n    useEffect(() => {\n        if (props.currentConversationId) {\n            setCurrentChat(loadedConversations.find((c) => (c.id = props.currentConversationId)));\n        }\n    }, [props.currentConversationId]);\n\n    useEffect(() => {\n        if (currentChat && userId) {\n            dispatch(getUnseenMessages(userId));\n        }\n    }, [currentChat]);\n\n    return (\n        <div className={classes.layout}>\n            <Grid container component={Paper} className={classes.chatSection}>\n                <ChatMenuComponent conversations={props.conversations} currentUser={props.currentUser} />\n                <Grid item xs={9}>\n                    {currentChat ? (\n                        <ChatBoxComponent conversation={currentChat} />\n                    ) : (\n                        <Typography variant=\"h2\" className=\"header-message\" className={classes.instructions}>\n                            Open a conversation to start a chat...\n                        </Typography>\n                    )}\n                </Grid>\n            </Grid>\n        </div>\n    );\n\n    function ChatMenuComponent(menuProps) {\n        const classes = useStyles();\n\n        const [searchName, setSearchName] = useState('');\n\n        const handleSearchChange = (e) => {\n            setSearchName(e.target.value);\n        };\n\n        return (\n            <Grid item xs={3} className={classes.chatMenu}>\n                <Grid item xs={12} className={classes.padding10}>\n                    <TextField\n                        className={classes.searchField}\n                        InputLabelProps={{ classeName: classes.label }}\n                        color=\"secondary\"\n                        variant=\"outlined\"\n                        label=\"Filter breeders...\"\n                        onChange={handleSearchChange}\n                        fullWidth\n                    />\n                </Grid>\n                <Divider />\n                <List>\n                    {menuProps.conversations\n                        .filter((c) => {\n                            if (c) {\n                                if (c.members) {\n                                    let friend = c.members.find((m) => {\n                                        return m._id !== props.currentUser.id;\n                                    });\n                                    if (friend.username) {\n                                        return friend.username.toLowerCase().includes(searchName.toLowerCase());\n                                    }\n                                }\n                            }\n                        })\n                        .map((c) => (\n                            <div\n                                onClick={() => {\n                                    setCurrentChat(c);\n                                }}\n                            >\n                                <ConversationComponent conversation={c} currentUser={menuProps.currentUser} isCurrentChat={currentChat ? c._id == currentChat._id : false} />\n                            </div>\n                        ))}\n                </List>\n            </Grid>\n        );\n    }\n\n    // TODO: Make scrolling to bottom message automatic\n    function ChatBoxComponent(chatProps) {\n        const classes = useStyles();\n        const [newMessage, setNewMessage] = useState('');\n\n        useEffect(() => {\n            let conversationId = chatProps.conversation._id;\n\n            async function loadMessages(id) {\n                if (id) {\n                    await dispatch(getMessages(id));\n                }\n            }\n\n            return loadMessages(conversationId);\n        }, [dispatch]);\n\n        const loadedMessages = useSelector((state) => state.messages.messages);\n\n        useEffect(() => {\n            setMessages(loadedMessages);\n        }, [loadedMessages]);\n\n        useEffect(() => {\n            if (Array.isArray(loadedMessages) && loadedMessages.length !== 0) {\n                let unseenMessages = loadedMessages.filter((m) => !m.seen && m.sender !== userId).map((m) => m._id);\n                if (unseenMessages.length !== 0) {\n                    dispatch(updateMessagesToSeen(unseenMessages));\n                }\n            }\n        }, [loadedMessages]);\n\n        const handleSubmit = async (e) => {\n            // Prevents refreshing of page on click\n            if (e) {\n                e.preventDefault();\n            }\n            const receiver = currentChat.members.find((member) => member._id !== userId);\n            const message = {\n                sender: userId,\n                receiver: receiver._id,\n                text: newMessage,\n                seen: false,\n                conversationId: chatProps.conversation._id,\n            };\n            setMessages([...messages]);\n            socket.current.emit('sendMessage', {\n                senderId: userId,\n                receiverId: receiver._id,\n                receiverEmail: receiver.email,\n                receiverUsername: receiver.username,\n                text: newMessage,\n            });\n            dispatch(addMessage(message));\n            setNewMessage('');\n        };\n\n        return !currentChat ? (\n            <Loading />\n        ) : (\n            <div>\n                <List className={classes.messageArea}>\n                    {Array.isArray(messages) && messages.length !== 0 ? (\n                        messages.map((m) => <MessageComponent message={m} />)\n                    ) : (\n                        <Typography variant=\"h2\" className=\"header-message\" className={classes.instructions}>\n                            Send a message to start a conversation with{' '}\n                            {\n                                currentChat.members.find((m) => {\n                                    return m._id !== props.currentUser.id;\n                                }).username\n                            }\n                            ...\n                        </Typography>\n                    )}\n                </List>\n                <Divider />\n                <Grid container className={classes.padding20}>\n                    <Grid item xs={11}>\n                        <TextField id=\"outlined-basic\" variant=\"outlined\" label=\"Write something...\" onChange={(e) => setNewMessage(e.target.value)} fullWidth />\n                    </Grid>\n                    <Grid item xs={1}>\n                        <Fab color=\"primary\" aria-label=\"add\" onClick={handleSubmit} className={classes.marginLeft10}>\n                            <SendIcon />\n                        </Fab>\n                    </Grid>\n                </Grid>\n            </div>\n        );\n    }\n}\n\nconst useStyles = makeStyles((theme) => ({\n    layout: {\n        width: '80%',\n        alignSelf: 'center',\n        paddingTop: theme.spacing(1),\n    },\n    table: {\n        minWidth: 650,\n    },\n    chatSection: {\n        width: '100%',\n        height: '85vh',\n    },\n    headBG: {\n        backgroundColor: '#e0e0e0',\n    },\n    chatMenu: {\n        borderRight: '1px solid #e0e0e0',\n        backgroundColor: theme.palette.primary.dark,\n        borderRadius: theme.shape.borderRadius,\n    },\n    messageArea: {\n        height: '70vh',\n        overflowY: 'auto',\n    },\n    padding10: {\n        padding: '10px',\n    },\n    padding20: {\n        padding: '20px',\n    },\n    marginLeft10: {\n        marginLeft: '10px',\n    },\n    instructions: {\n        padding: '20px',\n        color: theme.palette.primary.light,\n    },\n    searchField: {\n        color: theme.palette.text.secondary,\n        '& fieldset': {\n            borderColor: theme.palette.primary.light,\n        },\n        '& .MuiOutlinedInput-root': {\n            '&:hover fieldset': {\n                borderColor: theme.palette.secondary.main,\n            },\n        },\n        '&.Mui-focused fieldset': {\n            borderColor: theme.palette.secondary.main,\n        },\n        '& label': {\n            color: theme.palette.primary.light,\n        },\n    },\n}));\n\nexport default MessengerComponent;\n"]},"metadata":{},"sourceType":"module"}