{"ast":null,"code":"import _defineProperty from\"/Users/alinaturbina/Uni Projects/seba/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/defineProperty\";import _regeneratorRuntime from\"/Users/alinaturbina/Uni Projects/seba/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/regenerator\";import _objectSpread from\"/Users/alinaturbina/Uni Projects/seba/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/objectSpread2\";import _asyncToGenerator from\"/Users/alinaturbina/Uni Projects/seba/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/asyncToGenerator\";import _slicedToArray from\"/Users/alinaturbina/Uni Projects/seba/frontend/node_modules/babel-preset-react-app/node_modules/@babel/runtime/helpers/esm/slicedToArray\";import React,{useEffect,useState}from'react';import{makeStyles,withStyles}from'@material-ui/core/styles';import Stepper from'@material-ui/core/Stepper';import Step from'@material-ui/core/Step';import StepLabel from'@material-ui/core/StepLabel';import Button from'@material-ui/core/Button';import StepConnector from'@material-ui/core/StepConnector';import{Check}from'@material-ui/icons';import clsx from'clsx';import StepperInformation from'./StepperInformation';import{useLoggedInUser,useSelectedUser}from'helper/hooks/auth.hooks';import PaymentResultComponent from'./PaymentResult';import{useDispatch,useSelector}from'react-redux';import{changePet,createTransaction,getPet}from'redux/actions';import{NotificationService}from'services';import{jsx as _jsx}from\"react/jsx-runtime\";import{jsxs as _jsxs}from\"react/jsx-runtime\";var STATUS_TYPE={SUCCESS:'success',ERROR:'error'};var PaymentStepper=function PaymentStepper(_ref){var pet=_ref.pet,close=_ref.close;var classes=useStyles();var dispatch=useDispatch();var transaction=useSelector(function(state){return state.transaction.transaction;});var petOwner=useSelectedUser();var loggedInUser=useLoggedInUser();var _useState=useState('none'),_useState2=_slicedToArray(_useState,2),paymentStatus=_useState2[0],setPaymentStatus=_useState2[1];var _useState3=useState(0),_useState4=_slicedToArray(_useState3,2),activeStep=_useState4[0],setActiveStep=_useState4[1];var _useState5=useState(pet.price===0||pet.price===null),_useState6=_slicedToArray(_useState5,2),isFreeOfCharge=_useState6[0],setIsFreeOfCharge=_useState6[1];// if pet is free\nvar steps=['Confirm general information','Confirm payment','Finish'];useEffect(function(){if(loggedInUser){setIsFreeOfCharge(pet.price===0||pet.price===null);// premium user don't need to pay any fees for the free pet\n}},[loggedInUser,pet.ownerId,pet.price,dispatch]);var isButtonDisabled=activeStep===1&&!isFreeOfCharge;// helper functions for the transaction generation\nvar calculateFee=function calculateFee(){if(petOwner.subscriptionPlan==='free'){var fee=Math.min(pet.price*0.05,20);// 5% of the pet price or maximum 20€ as fee\nfee=Math.max(fee,1);// min 1€\nreturn fee;}return 0;};// generate order number for new transactions\nvar generateId=function generateId(){return Math.floor(Math.random()*10000000000).toString(16);};var transactionData={orderNr:generateId(),senderId:loggedInUser._id,receiverId:pet.ownerId,pet:pet.id,createdAt:new Date(),senderResponse:'pending',receiverResponse:'pending',status:'pending',amount:pet.price?pet.price:0,fee:calculateFee(),processed:false,reminderSent:false};// handle next step\nvar handleNext=function handleNext(){if(activeStep===steps.length-1){close();return;}// skip payment and create transaction directly\nif(isFreeOfCharge&&activeStep===1){onApprove();return;}setActiveStep(function(prevActiveStep){return prevActiveStep+1;});};// go one step back\nvar handleBack=function handleBack(){setActiveStep(function(prevActiveStep){return prevActiveStep-1;});};// main function for approval and transaction creation\nvar onApprove=/*#__PURE__*/function(){var _ref2=_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:setActiveStep(function(prevActiveStep){return prevActiveStep+1;});_context.next=3;return dispatch(createTransaction(transactionData,function(){NotificationService.notify('success','Transaction Created','Transaction was successfully created');setPaymentStatus(STATUS_TYPE.SUCCESS);// update pet status to purchased\n// update pet status to purchased\nvar newPet=_objectSpread(_objectSpread({},pet),{},{purchased:true});dispatch(changePet(newPet));dispatch(getPet(pet.id));},function(){NotificationService.notify('error','Transaction Error','Error occurred during transaction creation');setPaymentStatus(STATUS_TYPE.ERROR);}));case 3:case\"end\":return _context.stop();}}},_callee);}));return function onApprove(){return _ref2.apply(this,arguments);};}();// error handling\nvar onError=function onError(){setActiveStep(function(prevActiveStep){return prevActiveStep+1;});setPaymentStatus(STATUS_TYPE.ERROR);};var getStepContent=function getStepContent(stepIndex){switch(stepIndex){case 0:return/*#__PURE__*/_jsx(StepperInformation,{petOwner:petOwner,pet:pet,loggedInUser:loggedInUser,step:0,isFreeOfCharge:isFreeOfCharge,onApprove:onApprove,onError:onError});case 1:return/*#__PURE__*/_jsx(StepperInformation,{petOwner:petOwner,pet:pet,loggedInUser:loggedInUser,step:1,isFreeOfCharge:isFreeOfCharge,onApprove:onApprove,onError:onError});case 2:return/*#__PURE__*/_jsx(PaymentResultComponent,{status:paymentStatus,transaction:transaction});default:return'Unknown stepIndex';}};return/*#__PURE__*/_jsxs(\"div\",{className:classes.root,children:[/*#__PURE__*/_jsx(Stepper,{alternativeLabel:true,activeStep:activeStep,connector:/*#__PURE__*/_jsx(AlternativeConnector,{}),children:steps.map(function(label,index){var stepProps={};var labelProps={};return/*#__PURE__*/_jsx(Step,_objectSpread(_objectSpread({},stepProps),{},{children:/*#__PURE__*/_jsx(StepLabel,_objectSpread(_objectSpread({StepIconComponent:StepIcon},labelProps),{},{children:label}))}),label);})}),/*#__PURE__*/_jsx(\"div\",{children:activeStep===steps.length?null:/*#__PURE__*/_jsxs(\"div\",{children:[getStepContent(activeStep),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(Button,{disabled:activeStep===0||activeStep===2,onClick:handleBack,className:classes.button,variant:\"contained\",color:\"primary\",children:\"Back\"}),/*#__PURE__*/_jsx(Button,{disabled:isButtonDisabled,variant:\"contained\",color:\"primary\",onClick:handleNext,className:classes.button,children:activeStep===steps.length-1?'Finish':'Next'})]})]})})]});};/**\n * This function are used for the alternative styling of the stepper.\n */var AlternativeConnector=withStyles({alternativeLabel:{top:10,left:'calc(-50% + 16px)',right:'calc(50% + 16px)'},active:{'& $line':{borderColor:'#D37F65'}},completed:{'& $line':{borderColor:'#D37F65'}},line:{borderColor:'#eaeaf0',borderTopWidth:2,borderRadius:1}})(StepConnector);var useStepIconStyles=makeStyles({root:{color:'#eaeaf0',display:'flex',height:22,alignItems:'center'},active:{color:'#D37F65'},circle:{width:12,height:12,borderRadius:'50%',backgroundColor:'currentColor'},completed:{color:'#D37F65',zIndex:1,fontSize:18}});function StepIcon(props){var classes=useStepIconStyles();var active=props.active,completed=props.completed;return/*#__PURE__*/_jsx(\"div\",{className:clsx(classes.root,_defineProperty({},classes.active,active)),children:completed?/*#__PURE__*/_jsx(Check,{className:classes.completed}):/*#__PURE__*/_jsx(\"div\",{className:classes.circle})});}var useStyles=makeStyles(function(theme){return{root:{width:'100%'},button:{marginTop:theme.spacing(5),marginRight:theme.spacing(1)}};});export default PaymentStepper;","map":{"version":3,"sources":["/Users/alinaturbina/Uni Projects/seba/frontend/src/components/transactions/PaymentStepper.js"],"names":["React","useEffect","useState","makeStyles","withStyles","Stepper","Step","StepLabel","Button","StepConnector","Check","clsx","StepperInformation","useLoggedInUser","useSelectedUser","PaymentResultComponent","useDispatch","useSelector","changePet","createTransaction","getPet","NotificationService","STATUS_TYPE","SUCCESS","ERROR","PaymentStepper","pet","close","classes","useStyles","dispatch","transaction","state","petOwner","loggedInUser","paymentStatus","setPaymentStatus","activeStep","setActiveStep","price","isFreeOfCharge","setIsFreeOfCharge","steps","ownerId","isButtonDisabled","calculateFee","subscriptionPlan","fee","Math","min","max","generateId","floor","random","toString","transactionData","orderNr","senderId","_id","receiverId","id","createdAt","Date","senderResponse","receiverResponse","status","amount","processed","reminderSent","handleNext","length","onApprove","prevActiveStep","handleBack","notify","newPet","purchased","onError","getStepContent","stepIndex","root","map","label","index","stepProps","labelProps","StepIcon","button","AlternativeConnector","alternativeLabel","top","left","right","active","borderColor","completed","line","borderTopWidth","borderRadius","useStepIconStyles","color","display","height","alignItems","circle","width","backgroundColor","zIndex","fontSize","props","theme","marginTop","spacing","marginRight"],"mappings":"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","sourcesContent":["import React, { useEffect, useState } from 'react';\nimport { makeStyles, withStyles } from '@material-ui/core/styles';\nimport Stepper from '@material-ui/core/Stepper';\nimport Step from '@material-ui/core/Step';\nimport StepLabel from '@material-ui/core/StepLabel';\nimport Button from '@material-ui/core/Button';\nimport StepConnector from '@material-ui/core/StepConnector';\nimport { Check } from '@material-ui/icons';\nimport clsx from 'clsx';\nimport PropTypes from 'prop-types';\nimport StepperInformation from './StepperInformation';\nimport { useLoggedInUser, useSelectedUser } from 'helper/hooks/auth.hooks';\nimport PaymentResultComponent from './PaymentResult';\nimport { useDispatch, useSelector } from 'react-redux';\nimport { changePet, createTransaction, getPet } from 'redux/actions';\nimport { NotificationService } from 'services';\n\nconst STATUS_TYPE = {\n    SUCCESS: 'success',\n    ERROR: 'error',\n};\n\nconst PaymentStepper = ({ pet, close }) => {\n    const classes = useStyles();\n    const dispatch = useDispatch();\n\n    const transaction = useSelector((state) => state.transaction.transaction);\n    const petOwner = useSelectedUser();\n    const loggedInUser = useLoggedInUser();\n\n    const [paymentStatus, setPaymentStatus] = useState('none');\n    const [activeStep, setActiveStep] = useState(0);\n    const [isFreeOfCharge, setIsFreeOfCharge] = useState(pet.price === 0 || pet.price === null); // if pet is free\n\n    const steps = ['Confirm general information', 'Confirm payment', 'Finish'];\n\n\n    useEffect(() => {\n        if (loggedInUser) {\n            setIsFreeOfCharge(pet.price === 0 || pet.price === null) // premium user don't need to pay any fees for the free pet\n        }\n    }, [loggedInUser, pet.ownerId, pet.price, dispatch])\n\n\n    const isButtonDisabled = activeStep === 1 && !isFreeOfCharge;\n\n    // helper functions for the transaction generation\n    const calculateFee = () => {\n        if (petOwner.subscriptionPlan === 'free') {\n            let fee = Math.min(pet.price * 0.05, 20); // 5% of the pet price or maximum 20€ as fee\n            fee = Math.max(fee, 1); // min 1€\n            return fee;\n        }\n        return 0;\n    };\n    // generate order number for new transactions\n    const generateId = () => Math.floor(Math.random() * 10000000000).toString(16);\n    const transactionData = {\n        orderNr: generateId(),\n        senderId: loggedInUser._id,\n        receiverId: pet.ownerId,\n        pet: pet.id,\n        createdAt: new Date(),\n        senderResponse: 'pending',\n        receiverResponse: 'pending',\n        status: 'pending',\n        amount: pet.price ? pet.price : 0,\n        fee: calculateFee(),\n        processed: false,\n        reminderSent: false,\n    };\n\n    // handle next step\n    const handleNext = () => {\n        if (activeStep === steps.length - 1) {\n            close();\n            return;\n        }\n        // skip payment and create transaction directly\n        if (isFreeOfCharge && activeStep === 1) {\n            onApprove();\n            return;\n        }\n        setActiveStep((prevActiveStep) => prevActiveStep + 1);\n    };\n\n    // go one step back\n    const handleBack = () => {\n        setActiveStep((prevActiveStep) => prevActiveStep - 1);\n    };\n\n    // main function for approval and transaction creation\n    const onApprove = async () => {\n        setActiveStep((prevActiveStep) => prevActiveStep + 1);\n\n        await dispatch(\n            createTransaction(\n                transactionData,\n                () => {\n                    NotificationService.notify('success', 'Transaction Created', 'Transaction was successfully created');\n                    setPaymentStatus(STATUS_TYPE.SUCCESS);\n\n                    // update pet status to purchased\n                    let newPet = { ...pet, purchased: true };\n                    dispatch(changePet(newPet));\n                    dispatch(getPet(pet.id));\n                },\n                () => {\n                    NotificationService.notify('error', 'Transaction Error', 'Error occurred during transaction creation');\n                    setPaymentStatus(STATUS_TYPE.ERROR);\n                }\n            )\n        );\n    };\n\n    // error handling\n    const onError = () => {\n        setActiveStep((prevActiveStep) => prevActiveStep + 1);\n        setPaymentStatus(STATUS_TYPE.ERROR);\n    };\n\n    const getStepContent = (stepIndex) => {\n        switch (stepIndex) {\n            case 0:\n                return <StepperInformation petOwner={petOwner} pet={pet} loggedInUser={loggedInUser} step={0} isFreeOfCharge={isFreeOfCharge} onApprove={onApprove} onError={onError} />;\n            case 1:\n                return <StepperInformation petOwner={petOwner} pet={pet} loggedInUser={loggedInUser} step={1} isFreeOfCharge={isFreeOfCharge} onApprove={onApprove} onError={onError} />;\n            case 2:\n                return <PaymentResultComponent status={paymentStatus} transaction={transaction} />;\n            default:\n                return 'Unknown stepIndex';\n        }\n    };\n\n    return (\n        <div className={classes.root}>\n            <Stepper alternativeLabel activeStep={activeStep} connector={<AlternativeConnector />}>\n                {steps.map((label, index) => {\n                    const stepProps = {};\n                    const labelProps = {};\n                    return (\n                        <Step key={label} {...stepProps}>\n                            <StepLabel StepIconComponent={StepIcon} {...labelProps}>\n                                {label}\n                            </StepLabel>\n                        </Step>\n                    );\n                })}\n            </Stepper>\n            <div>\n                {activeStep === steps.length ? null : (\n                    <div>\n                        {getStepContent(activeStep)}\n                        <div>\n                            <Button disabled={activeStep === 0 || activeStep === 2} onClick={handleBack} className={classes.button} variant=\"contained\" color=\"primary\">\n                                Back\n                            </Button>\n                            <Button disabled={isButtonDisabled} variant=\"contained\" color=\"primary\" onClick={handleNext} className={classes.button}>\n                                {activeStep === steps.length - 1 ? 'Finish' : 'Next'}\n                            </Button>\n                        </div>\n                    </div>\n                )}\n            </div>\n        </div>\n    );\n};\n\n/**\n * This function are used for the alternative styling of the stepper.\n */\nconst AlternativeConnector = withStyles({\n    alternativeLabel: {\n        top: 10,\n        left: 'calc(-50% + 16px)',\n        right: 'calc(50% + 16px)',\n    },\n    active: {\n        '& $line': {\n            borderColor: '#D37F65',\n        },\n    },\n    completed: {\n        '& $line': {\n            borderColor: '#D37F65',\n        },\n    },\n    line: {\n        borderColor: '#eaeaf0',\n        borderTopWidth: 2,\n        borderRadius: 1,\n    },\n})(StepConnector);\n\nconst useStepIconStyles = makeStyles({\n    root: {\n        color: '#eaeaf0',\n        display: 'flex',\n        height: 22,\n        alignItems: 'center',\n    },\n    active: {\n        color: '#D37F65',\n    },\n    circle: {\n        width: 12,\n        height: 12,\n        borderRadius: '50%',\n        backgroundColor: 'currentColor',\n    },\n    completed: {\n        color: '#D37F65',\n        zIndex: 1,\n        fontSize: 18,\n    },\n});\n\nfunction StepIcon(props) {\n    const classes = useStepIconStyles();\n    const { active, completed } = props;\n\n    return (\n        <div\n            className={clsx(classes.root, {\n                [classes.active]: active,\n            })}\n        >\n            {completed ? <Check className={classes.completed} /> : <div className={classes.circle} />}\n        </div>\n    );\n}\n\nStepIcon.propTypes = {\n    active: PropTypes.bool, // Whether this step is active.\n    completed: PropTypes.bool, // Mark the step as completed. Is passed to child components.\n};\n\nconst useStyles = makeStyles((theme) => ({\n    root: {\n        width: '100%',\n    },\n    button: {\n        marginTop: theme.spacing(5),\n        marginRight: theme.spacing(1),\n    },\n}));\n\nexport default PaymentStepper;\n"]},"metadata":{},"sourceType":"module"}